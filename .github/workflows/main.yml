name: Windows - Ngrok RDP

on: workflow_dispatch

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
  RDP_USER: admin
  RDP_PASS: ${{ secrets.RDP_PASS }}

jobs:
  ngrok-rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Enable RDP + Create User
      shell: powershell
      run: |
        Write-Host "Enabling RDP..."
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' fDenyTSConnections 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        Write-Host "Creating admin user..."
        $pass = ConvertTo-SecureString "$env:RDP_PASS" -AsPlainText -Force

        if (-not (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue)) {
          New-LocalUser $env:RDP_USER -Password $pass
          Add-LocalGroupMember -Group Administrators -Member $env:RDP_USER
        } else {
          Set-LocalUser $env:RDP_USER -Password $pass
        }

        Write-Host "RDP Ready."

    - name: Install Ngrok
      shell: powershell
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN

    - name: Start Ngrok Tunnel
      shell: powershell
      run: |
        Start-Process .\ngrok\ngrok.exe "tcp 3389" -WindowStyle Hidden
        Start-Sleep 10

        $data = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels
        $url = ($data.tunnels | Where proto -eq "tcp").public_url
        $url = $url -replace "tcp://",""

        Write-Host ""
        Write-Host "=============================="
        Write-Host "RDP ADDRESS : $url"
        Write-Host "USERNAME    : $env:RDP_USER"
        Write-Host "PASSWORD    : $env:RDP_PASS"
        Write-Host "=============================="
        Write-Host ""

    - name: Keep Alive (6 Hours)
      shell: powershell
      run: |
        for ($i=0; $i -lt 72; $i++) {
          Start-Sleep 300
          if (-not (Get-Process ngrok -ErrorAction SilentlyContinue)) {
            exit 1
          }
        }
