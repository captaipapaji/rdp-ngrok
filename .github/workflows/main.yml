name: Windows - Ngrok RDP

on:
  workflow_dispatch:

env:
  NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
  RDP_USER: admin
  RDP_PASS: ${{ secrets.RDP_PASS }}

jobs:
  rdp:
    runs-on: windows-latest
    timeout-minutes: 360

    steps:

    - name: Enable RDP + Create Admin User
      shell: powershell
      run: |
        Write-Host "Enabling RDP..."
        Set-ItemProperty 'HKLM:\System\CurrentControlSet\Control\Terminal Server' fDenyTSConnections 0
        Enable-NetFirewallRule -DisplayGroup "Remote Desktop"

        if (-not $env:RDP_PASS) {
          Write-Error "RDP_PASS secret missing!"
          exit 1
        }

        $pass = ConvertTo-SecureString $env:RDP_PASS -AsPlainText -Force

        if (Get-LocalUser -Name $env:RDP_USER -ErrorAction SilentlyContinue) {
          Set-LocalUser -Name $env:RDP_USER -Password $pass
        } else {
          New-LocalUser -Name $env:RDP_USER -Password $pass -PasswordNeverExpires
          Add-LocalGroupMember -Group Administrators -Member $env:RDP_USER
        }

        Write-Host "RDP ready."

    - name: Install Ngrok
      shell: powershell
      run: |
        Invoke-WebRequest https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
        Expand-Archive ngrok.zip
        .\ngrok\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN

    - name: Start Ngrok Tunnel
      shell: powershell
      run: |
        Start-Process .\ngrok\ngrok.exe "tcp 3389 --log=stdout" -WindowStyle Hidden

        Write-Host "Waiting for ngrok..."

        $url = $null

        for ($i=0; $i -lt 40; $i++) {
          Start-Sleep 5
          try {
            $data = Invoke-RestMethod http://127.0.0.1:4040/api/tunnels
            $url = ($data.tunnels | Where proto -eq "tcp").public_url
            if ($url) { break }
          } catch {
            Write-Host "Ngrok not ready..."
          }
        }

        if (-not $url) {
          Write-Error "Ngrok tunnel not created."
          exit 1
        }

        $url = $url -replace "tcp://",""

        Write-Host ""
        Write-Host "=============================="
        Write-Host "RDP ADDRESS : $url"
        Write-Host "USERNAME    : $env:RDP_USER"
        Write-Host "PASSWORD    : $env:RDP_PASS"
        Write-Host "=============================="
        Write-Host ""

    - name: Keep Alive (6 Hours)
      shell: powershell
      run: |
        for ($i=0; $i -lt 72; $i++) {
          Start-Sleep 300
          if (-not (Get-Process ngrok -ErrorAction SilentlyContinue)) {
            exit 1
          }
        }
